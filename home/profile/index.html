<!DOCTYPE html>
<html lang="en">
<head>
    <title>Login V3</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
<!--===============================================================================================-->	
	<link rel="icon" type="image/png" href="../../images/icons/favicon.ico"/>
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../../vendor/bootstrap/css/bootstrap.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../../fonts/font-awesome-4.7.0/css/font-awesome.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../../fonts/iconic/css/material-design-iconic-font.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../../vendor/animate/animate.css">
<!--===============================================================================================-->	
	<link rel="stylesheet" type="text/css" href="../../vendor/css-hamburgers/hamburgers.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../../vendor/animsition/css/animsition.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../../vendor/select2/select2.min.css">
<!--===============================================================================================-->	
	<link rel="stylesheet" type="text/css" href="../../vendor/daterangepicker/daterangepicker.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../../css/util.css">
    <link rel="stylesheet" type="text/css" href="../../css/main.css">
<!--===============================================================================================-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.0/moment.min.js"></script>
</head>
<body>
	<div class="limiter">
        <div class="container-login100" style="background-image: url('../../images/bg-01.jpg');">
			<div class="wrap-profile100">
                <div class="profile100-form-title p-b-34 p-t-27">Your Profile</div>

                <div class="tab">
                    <button class="tablinks" onclick="openCity(event, 'transactions')">Transactions</button>
                    <button class="tablinks" onclick="openCity(event, 'reports')">Reports</button>
                </div>
                
                <!-- Tab content -->
                <div id="transactions" class="tabcontent">
                    <h3 style="text-align:center;">Your Transactions</h3>
                    <div style="margin-top:20px" class="row">
                        <div style="text-align:center; color:#0E4D92; font-size:20px; " id="desc" class="column"><b>Description</b></div>
                        <div style="text-align:center; color:#0E4D92; font-size:20px; margin-bottom: 10px;" id="type" class="column"><b>Type</b></div>
                        <div style="text-align:center; color:#0E4D92; font-size:20px; margin-bottom: 10px;" id="amt"  class="column"><b>Amount</b></div>
                        <div style="text-align:center; color:#0E4D92; font-size:20px; margin-bottom: 10px;" id="date" class="column"><b>Date</b></div>
                    </div>
                </div>
                
                <div id="reports" class="tabcontent">
                    <h3 style="text-align:center;">Your April Spendings</h3>
                    
                    <div class = "row">
                        <div class="column" id="chartContainer" style="height: 300px; margin-left:5px"></div>
                        <div class="column" style="width:50%; margin-left:180px; margin-top: 20px" id="transList"></div>
                    </div>
                </div>
            
			</div>
        </div>

	</div>
	
<!--===============================================================================================-->
	<script src="../../vendor/jquery/jquery-3.2.1.min.js"></script>
<!--===============================================================================================-->
	<script src="../../vendor/animsition/js/animsition.min.js"></script>
<!--===============================================================================================-->
	<script src="../../vendor/bootstrap/js/popper.js"></script>
	<script src="../../vendor/bootstrap/js/bootstrap.min.js"></script>
<!--===============================================================================================-->
	<script src="../../vendor/select2/select2.min.js"></script>
<!--===============================================================================================-->
	<script src="../../vendor/daterangepicker/moment.min.js"></script>
	<script src="../../vendor/daterangepicker/daterangepicker.js"></script>
<!--===============================================================================================-->
	<script src="../../vendor/countdowntime/countdowntime.js"></script>
<!--===============================================================================================-->
	<script src="../../js/main.js"></script>

    <script>
        $(function(){
            require(['account', 'purchase', 'merchant', 'customer'], function (account, purchase, merchant, customer) {
                var apikey = '23f5a1ad670d7e31c97240067fdf7efd';

                var acct = account.initWithKey(apikey);
                var cust = customer.initWithKey(apikey);
                var purchases = purchase.initWithKey(apikey);
                var merchants = merchant.initWithKey(apikey);

                var allaccounts = acct.getAllAccounts();

                var id = allaccounts[0]._id;

                displayPurchases(purchases.getAll(String(id)), merchants);
                monthlyReports(purchases.getAll(String(id)), merchants);
            });

        });

        function monthlyReports(purchases, merchants) {
            var mapping = {
                "tech": [0.0, [], []],
                "food": [0.0, [], []],
                "clothing": [0.0, [], []],
                "entertainment": [0.0, [], []]
            };
            total = 0.0;

            for (var i = 0; i < purchases.length; i++) {
                merchant = merchants.getMerchant(purchases[i].merchant_id);
                categories = merchant.category; 

                for (var j = 0; j < categories.length; j++) {
                    currCat = categories[j];
                    if (currCat.toLowerCase() == "restaurant") {
                        mapping["food"][0] = mapping["food"][0] + purchases[i].amount; 
                        mapping["food"][1].push(merchant);
                        mapping["food"][2].push(purchases[i]);
                        total += purchases[i].amount;
                    }
                    else if (currCat.toLowerCase() == "tech") {
                        mapping["tech"][0] = mapping["tech"][0] + purchases[i].amount; 
                        mapping["tech"][1].push(merchant);
                        mapping["tech"][2].push(purchases[i]);
                        total += purchases[i].amount;
                    }
                    else if (currCat.toLowerCase() == "food") {
                        mapping["food"][0] = mapping["food"][0] + purchases[i].amount; 
                        mapping["food"][1].push(merchant);
                        mapping["food"][2].push(purchases[i]);
                        total += purchases[i].amount;
                    }
                    else if (currCat.toLowerCase() == "clothing") {
                        mapping["clothing"][0] = mapping["clothing"][0] + purchases[i].amount; 
                        mapping["clothing"][1].push(merchant);
                        mapping["clothing"][2].push(purchases[i]);
                        total += purchases[i].amount;
                    }
                    else if (currCat.toLowerCase() == "entertainment") {
                        mapping["entertainment"][0] = mapping["entertainment"][0] + purchases[i].amount; 
                        mapping["entertainment"][1].push(merchant);
                        mapping["entertainment"][2].push(purchases[i]);
                        total += purchases[i].amount;}
                }
            }

            createChart(mapping, total);
        }

        function displayPurchases(purchases, merchants) {
            for (var i = 0; i < purchases.length; i++) {
                document.getElementById('desc').innerHTML += 
                    '<div style="margin-top: 10px; color:black; font-size: 16px;">' + merchants.getMerchant(purchases[i].merchant_id).name + '</div>';
                document.getElementById('type').innerHTML += 
                    '<div style="margin-top: 10px; color:black; font-size: 16px;">Purchase</div>';
                document.getElementById('amt').innerHTML += 
                    '<div style="margin-top: 10px; color:red; font-size: 16px;"> - $' + purchases[i].amount + '</div>';
                document.getElementById('date').innerHTML += 
                    '<div style="margin-top: 10px; color:black;font-size: 16px;"">' + moment(purchases[i].purchase_date, 'YYYY-MM-DD').format('MMMM D, Y') + '</div>';    
            }
        }

        function sumPurchases(purchases) {
            var sum = 0;
            for (var i = 0; i < purchases.length; i++){
                curr = purchases[i];
                console.log(curr.amount)
                sum += curr.amount;
            }
            return sum;
        }

    </script>

    <script>
        function createChart(mapping, total) {
            var chart = new CanvasJS.Chart("chartContainer", {
                height: 300,
                animationEnabled: true,
                backgroundColor: "#ccc",
                title: {text: ""},
                data: [{
                    type: "pie",
                    click: onClick,
                    startAngle: 240,
                    radius: 100,
                    yValueFormatString: "##0.00\"%\"",
                    indexLabel: "{label} {y}",
                    dataPoints: []
                }]
            });

            for (key in mapping) {
                if (mapping[key][0] > 0) {
                    chart.options.data[0].dataPoints.push({y: (mapping[key][0] / total) * 100, label: key});
                }
            }

            chart.render();

            function onClick(e) {
                clicked = (e.chart.options.data[0].dataPoints[e.dataPointIndex]).label
                document.getElementById('transList').innerHTML = 'Your ' + clicked + ' Transactions<br>';
                for (key in mapping) {
                    if (key === clicked) { 
                        purchases = mapping[key][2];
                        merchants = mapping[key][1];
                        for (var i = 0; i < purchases.length; i++) {
                            document.getElementById('transList').innerHTML += merchants[i].name + " ";
                            document.getElementById('transList').innerHTML += "- $" + purchases[i].amount + " ";
                            document.getElementById('transList').innerHTML += moment(purchases[i].purchase_date, 'YYYY-MM-DD').format('MMMM D, Y') + "<br>"
                        }
                    }
                }
            }

        }
    </script>


    <script>
        function openCity(evt, cityName) {
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(cityName).style.display = "block";
        evt.currentTarget.className += " active";
        }
    </script>

    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
    <script data-main="lib/capital_one" src="lib/require-jquery.js"></script>


</body>
</html>